var Xenon=function(){"use strict";var t="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==t&&t||{},a="URLSearchParams"in e,r="Symbol"in e&&"iterator"in Symbol,i="FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(t){return!1}}(),n="FormData"in e,s="ArrayBuffer"in e;if(s)var o=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(t){return t&&o.indexOf(Object.prototype.toString.call(t))>-1};function c(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(t)||""===t)throw new TypeError('Invalid character in header field name: "'+t+'"');return t.toLowerCase()}function l(t){return"string"!=typeof t&&(t=String(t)),t}function d(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return r&&(e[Symbol.iterator]=function(){return e}),e}function h(t){this.map={},t instanceof h?t.forEach((function(t,e){this.append(e,t)}),this):Array.isArray(t)?t.forEach((function(t){if(2!=t.length)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+t.length);this.append(t[0],t[1])}),this):t&&Object.getOwnPropertyNames(t).forEach((function(e){this.append(e,t[e])}),this)}function p(t){if(!t._noBody)return t.bodyUsed?Promise.reject(new TypeError("Already read")):void(t.bodyUsed=!0)}function m(t){return new Promise((function(e,a){t.onload=function(){e(t.result)},t.onerror=function(){a(t.error)}}))}function y(t){var e=new FileReader,a=m(e);return e.readAsArrayBuffer(t),a}function f(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function w(){return this.bodyUsed=!1,this._initBody=function(t){var e;this.bodyUsed=this.bodyUsed,this._bodyInit=t,t?"string"==typeof t?this._bodyText=t:i&&Blob.prototype.isPrototypeOf(t)?this._bodyBlob=t:n&&FormData.prototype.isPrototypeOf(t)?this._bodyFormData=t:a&&URLSearchParams.prototype.isPrototypeOf(t)?this._bodyText=t.toString():s&&i&&((e=t)&&DataView.prototype.isPrototypeOf(e))?(this._bodyArrayBuffer=f(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):s&&(ArrayBuffer.prototype.isPrototypeOf(t)||u(t))?this._bodyArrayBuffer=f(t):this._bodyText=t=Object.prototype.toString.call(t):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):a&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},i&&(this.blob=function(){var t=p(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var t=p(this);return t||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}if(i)return this.blob().then(y);throw new Error("could not read as ArrayBuffer")},this.text=function(){var t,e,a,r,i,n=p(this);if(n)return n;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,a=m(e),r=/charset=([A-Za-z0-9_-]+)/.exec(t.type),i=r?r[1]:"utf-8",e.readAsText(t,i),a;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),a=new Array(e.length),r=0;r<e.length;r++)a[r]=String.fromCharCode(e[r]);return a.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},n&&(this.formData=function(){return this.text().then(A)}),this.json=function(){return this.text().then(JSON.parse)},this}h.prototype.append=function(t,e){t=c(t),e=l(e);var a=this.map[t];this.map[t]=a?a+", "+e:e},h.prototype.delete=function(t){delete this.map[c(t)]},h.prototype.get=function(t){return t=c(t),this.has(t)?this.map[t]:null},h.prototype.has=function(t){return this.map.hasOwnProperty(c(t))},h.prototype.set=function(t,e){this.map[c(t)]=l(e)},h.prototype.forEach=function(t,e){for(var a in this.map)this.map.hasOwnProperty(a)&&t.call(e,this.map[a],a,this)},h.prototype.keys=function(){var t=[];return this.forEach((function(e,a){t.push(a)})),d(t)},h.prototype.values=function(){var t=[];return this.forEach((function(e){t.push(e)})),d(t)},h.prototype.entries=function(){var t=[];return this.forEach((function(e,a){t.push([a,e])})),d(t)},r&&(h.prototype[Symbol.iterator]=h.prototype.entries);var g=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function b(t,a){if(!(this instanceof b))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var r,i,n=(a=a||{}).body;if(t instanceof b){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,a.headers||(this.headers=new h(t.headers)),this.method=t.method,this.mode=t.mode,this.signal=t.signal,n||null==t._bodyInit||(n=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=a.credentials||this.credentials||"same-origin",!a.headers&&this.headers||(this.headers=new h(a.headers)),this.method=(r=a.method||this.method||"GET",i=r.toUpperCase(),g.indexOf(i)>-1?i:r),this.mode=a.mode||this.mode||null,this.signal=a.signal||this.signal||function(){if("AbortController"in e)return(new AbortController).signal}(),this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(n),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==a.cache&&"no-cache"!==a.cache)){var s=/([?&])_=[^&]*/;if(s.test(this.url))this.url=this.url.replace(s,"$1_="+(new Date).getTime());else{this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function A(t){var e=new FormData;return t.trim().split("&").forEach((function(t){if(t){var a=t.split("="),r=a.shift().replace(/\+/g," "),i=a.join("=").replace(/\+/g," ");e.append(decodeURIComponent(r),decodeURIComponent(i))}})),e}function v(t,e){if(!(this instanceof v))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=void 0===e.statusText?"":""+e.statusText,this.headers=new h(e.headers),this.url=e.url||"",this._initBody(t)}b.prototype.clone=function(){return new b(this,{body:this._bodyInit})},w.call(b.prototype),w.call(v.prototype),v.prototype.clone=function(){return new v(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new h(this.headers),url:this.url})},v.error=function(){var t=new v(null,{status:200,statusText:""});return t.ok=!1,t.status=0,t.type="error",t};var _=[301,302,303,307,308];v.redirect=function(t,e){if(-1===_.indexOf(e))throw new RangeError("Invalid status code");return new v(null,{status:e,headers:{location:t}})};var C=e.DOMException;try{new C}catch(t){(C=function(t,e){this.message=t,this.name=e;var a=Error(t);this.stack=a.stack}).prototype=Object.create(Error.prototype),C.prototype.constructor=C}function P(t,a){return new Promise((function(r,n){var o=new b(t,a);if(o.signal&&o.signal.aborted)return n(new C("Aborted","AbortError"));var u=new XMLHttpRequest;function d(){u.abort()}if(u.onload=function(){var t,e,a={statusText:u.statusText,headers:(t=u.getAllResponseHeaders()||"",e=new h,t.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(t){return 0===t.indexOf("\n")?t.substr(1,t.length):t})).forEach((function(t){var a=t.split(":"),r=a.shift().trim();if(r){var i=a.join(":").trim();try{e.append(r,i)}catch(t){console.warn("Response "+t.message)}}})),e)};0===o.url.indexOf("file://")&&(u.status<200||u.status>599)?a.status=200:a.status=u.status,a.url="responseURL"in u?u.responseURL:a.headers.get("X-Request-URL");var i="response"in u?u.response:u.responseText;setTimeout((function(){r(new v(i,a))}),0)},u.onerror=function(){setTimeout((function(){n(new TypeError("Network request failed"))}),0)},u.ontimeout=function(){setTimeout((function(){n(new TypeError("Network request timed out"))}),0)},u.onabort=function(){setTimeout((function(){n(new C("Aborted","AbortError"))}),0)},u.open(o.method,function(t){try{return""===t&&e.location.href?e.location.href:t}catch(e){return t}}(o.url),!0),"include"===o.credentials?u.withCredentials=!0:"omit"===o.credentials&&(u.withCredentials=!1),"responseType"in u&&(i?u.responseType="blob":s&&(u.responseType="arraybuffer")),a&&"object"==typeof a.headers&&!(a.headers instanceof h||e.Headers&&a.headers instanceof e.Headers)){var p=[];Object.getOwnPropertyNames(a.headers).forEach((function(t){p.push(c(t)),u.setRequestHeader(t,l(a.headers[t]))})),o.headers.forEach((function(t,e){-1===p.indexOf(e)&&u.setRequestHeader(e,t)}))}else o.headers.forEach((function(t,e){u.setRequestHeader(e,t)}));o.signal&&(o.signal.addEventListener("abort",d),u.onreadystatechange=function(){4===u.readyState&&o.signal.removeEventListener("abort",d)}),u.send(void 0===o._bodyInit?null:o._bodyInit)}))}async function O(t){if(t.status>=200&&t.status<400)return t;if(t.status>=400&&t.status<500){const e=await t.json(),a=new Error(e.error_message);return a.response=t,a.details=e,a.authIssue=!0,Promise.reject(a)}const e=new Error(t.statusText);return e.response=t,Promise.reject(e)}P.polyfill=!0,e.fetch||(e.fetch=P,e.Headers=h,e.Request=b,e.Response=v),self.fetch.bind(self);class S{constructor(t={}){const{name:e,method:a,headers:r,url:i,skipName:n,authenticated:s,apiUrl:o}=t;this.authenticated=s||!1,this.skipName=n||!1,this.name=e||"ApiBase",this.method=a||"POST",this.headers=r||{"content-type":"application/json"},this.apiUrl=o||null!=o?o:"https://app.xenonview.com",this.path_=i||""}params(t){return{}}path(t){return this.path_}fetch({data:t}={}){let e={};try{e=this.params(t)}catch(t){return Promise.reject(t)}let a={method:this.method,headers:this.headers};if(Object.keys(e).length||!this.skipName){let t={parameters:e};this.skipName||(t.name=this.name);const r=JSON.stringify(t);a.body=r}if(this.authenticated){const{token:e}=t;if(!e)return Promise.reject(new Error("No token and authenticated!"));a.accessToken=e}return function(t,{accessToken:e,headers:a,...r}={}){return r={credentials:"same-origin",keepalive:!0,headers:{accept:"application/json",...e?{authorization:`Bearer ${e}`}:{},...a},...r},fetch(t,r).then(O).then((t=>[204,304].includes(t.status)?{}:t.json())).catch((t=>{if(t instanceof TypeError){const t=new Error("Your internet connection appears to have gone down.");return t.noNet=!0,Promise.reject(t)}return Promise.reject(t)}))}(`${this.apiUrl}/${this.path(t)}`,a)}}class j extends S{constructor(t){super({name:"ApiJourney",url:"journey",apiUrl:t,authenticated:!0})}params(t){let e=function(t){const{journey:e}=t;return e?{journey:e}:{}}(t);const{id:a,timestamp:r}=t;return e.uuid=a,e.timestamp=r,e}}function T(t){return new j(t)}class U extends S{constructor(t){super({name:"ApiHeartbeat",url:"heartbeat",apiUrl:t,authenticated:!0})}params(t){let e=function(t){const{journey:e}=t;return e?{journey:e}:{}}(t);const{id:a,tags:r,platform:i,timestamp:n,watchdog:s}=t;return e.uuid=a,e.timestamp=n,e.tags=r,e.platform=i,s&&(e.watchdog=s),e}}function E(t){return new U(t)}class x extends S{constructor(t){super({name:"ApiDeanonymize",url:"deanonymize",apiUrl:t,authenticated:!0})}params(t){const{id:e,person:a,timestamp:r}=t;if(!a)throw new Error("No person data received.");let i={};return i.uuid=e,i.person=a,i.timestamp=r,i}}function D(t){return new x(t)}class I extends S{constructor(t){super({name:"ApiSample",url:"sample",apiUrl:t,authenticated:!0})}params(t){const{id:e}=t;let a={};return a.uuid=e,a}}function B(t){return new I(t)}class R extends S{constructor(t){super({name:"ApiIncrementCount",url:"increment_count",apiUrl:t,authenticated:!0})}params(t){const{uid:e,timestamp:a,outcome:r,content:i,value:n}=t,{leadSource:s,leadCampaign:o,leadGuid:u}=i;let c={};return c.uid=e,c.timestamp=a,c.outcome=r,c.leadSource=s,c.leadCampaign=o,c.leadGuid=u,c.value=n,c}}function k(t){return new R(t)}class F extends S{constructor(t){super({name:"ApiErrorLog",url:"error_log",apiUrl:t,authenticated:!0})}params(t){const{log:e}=t;let a={};return a.log=e,a}}function L(t){return new F(t)}const N={},J={setItem:(t,e)=>N[t]=e,getItem:t=>N[t],removeItem:t=>delete N[t]},H={},G={setItem:(t,e)=>H[t]=e,getItem:t=>H[t],removeItem:t=>delete H[t]};class q{constructor(t){this._underlying=t}async setItem(t,e){await this._underlying.setItem(t,e)}async getItem(t){return await this._underlying.getItem(t)}async removeItem(t){await this._underlying.removeItem(t)}}function V(){if("undefined"!=typeof window&&void 0!==window&&window&&window.localStorage)return window.localStorage;const t="undefined"!=typeof self&&self.browser?self.browser:null;return void 0!==t&&void 0!==t&&t&&t.localStorage?new q(t.localStorage):G}function K(){if("undefined"!=typeof window&&void 0!==window&&window&&window.sessionStorage)return window.sessionStorage;const t="undefined"!=typeof self&&self.browser?self.browser:null;return void 0!==t&&void 0!==t&&t&&t.sessionStorage?new q(t.sessionStorage):J}async function M(t,e){const a=V();await a.setItem(t,JSON.stringify(e))}async function z(t){const e=V(),a=await e.getItem(t);return a?JSON.parse(a):null}async function $(t){const e=V();await e.removeItem(t)}async function X(t,e){const a=K();await a.setItem(t,JSON.stringify(e))}async function Y(t){const e=K(),a=await e.getItem(t);return a?JSON.parse(a):null}async function W(t){const e=K();await e.removeItem(t)}const Z=new class{constructor(t=null,e="https://app.xenonview.com",a="https://counts.xenonlab.ai",r=T,i=D,n=E,s=B,o=k,u=L){this.JourneyApi=r,this.DeanonApi=i,this.HeartbeatApi=n,this.SampleApi=s,this.CountApi=o,this.ErrorLogApi=u,this.pageURL_=null,this.restoreJourney=[],this.apiCallPending=!1,this.apiUrl=e,this.countApiUrl=a}version(){return"v0.1.40.0"}async init(t,e="https://app.xenonview.com",a=null){this.apiUrl=e,this.apiKey=t,await this.id(),await this.journey()||await this.storeJourney([]),await this.sampleDecision(null,a),this.apiCallPending=!1}async ecomAbandonment(){await M("heartbeat_type","ecom"),await this.heartbeatState(0)}async customAbandonment(t){await M("heartbeat_type","custom"),await M("heartbeat_outcome",t),await this.heartbeatState(0)}async cancelAbandonment(){await M("heartbeat_type","custom"),await M("heartbeat_outcome",{remove:!0}),await this.heartbeatState(0)}async platform(t,e,a,r){const i={softwareVersion:t,deviceModel:e,operatingSystemName:a,operatingSystemVersion:r};await X("view-platform",i)}async removePlatform(){await W("view-platform")}async variant(t){await X("view-tags",t)}async resetVariants(){await W("view-tags")}async startVariant(t){let e=await Y("view-tags");e&&e.includes(t)||(await this.resetVariants(),await this.variant([t]))}async addVariant(t){let e=await Y("view-tags");e&&e.includes(t)||(e?e.push(t):e=[t],await this.variant(e))}async leadAttributed(t,e=null){await this.count("Attribution")}async leadUnattributed(){await this.count("Attribution")}async leadCaptured(t){const e={superOutcome:"Lead Capture",outcome:t,result:"success"};await this.outcomeAdd(e)}async leadCaptureDeclined(t){const e={superOutcome:"Lead Capture",outcome:t,result:"fail"};await this.outcomeAdd(e)}async accountSignup(t){const e={superOutcome:"Account Signup",outcome:t,result:"success"};await this.outcomeAdd(e)}async accountSignupDeclined(t){const e={superOutcome:"Account Signup",outcome:t,result:"fail"};await this.outcomeAdd(e)}async applicationInstalled(){await this.outcomeAdd({superOutcome:"Application Installation",outcome:"Installed",result:"success"})}async applicationNotInstalled(){await this.outcomeAdd({superOutcome:"Application Installation",outcome:"Not Installed",result:"fail"})}async initialSubscription(t,e=null,a=null,r=null){const i={superOutcome:"Initial Subscription",outcome:"Subscribe - "+t,result:"success"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionDeclined(t,e=null,a=null,r=null){const i={superOutcome:"Initial Subscription",outcome:"Decline - "+t,result:"fail"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionRenewed(t,e=null,a=null,r=null){const i={superOutcome:"Subscription Renewal",outcome:"Renew - "+t,result:"success"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionPaused(t,e=null,a=null,r=null){const i={superOutcome:"Subscription Renewal",outcome:"Paused - "+t,result:"fail"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionCanceled(t,e=null,a=null,r=null){const i={superOutcome:"Subscription Renewal",outcome:"Cancel - "+t,result:"fail"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionUpsold(t,e=null,a=null,r=null){const i={superOutcome:"Subscription Upsold",outcome:"Upsold - "+t,result:"success"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionUpsellDeclined(t,e=null,a=null,r=null){const i={superOutcome:"Subscription Upsold",outcome:"Declined - "+t,result:"fail"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async subscriptionDownsell(t,e=null,a=null,r=null){const i={superOutcome:"Subscription Upsold",outcome:"Downsell - "+t,result:"fail"};e&&(i.method=e),a&&(i.price=a),r&&(i.term=r),await this.outcomeAdd(i)}async adClicked(t,e=null,a=null){const r={superOutcome:"Advertisement",outcome:"Ad Click - "+t,result:"success"};e&&(r.id=e),a&&(r.price=a),await this.outcomeAdd(r)}async adIgnored(t,e=null,a=null){const r={superOutcome:"Advertisement",outcome:"Ad Ignored - "+t,result:"fail"};e&&(r.id=e),a&&(r.price=a),await this.outcomeAdd(r)}async referral(t,e=null){const a={superOutcome:"Referral",outcome:"Referred - "+t,result:"success"};e&&(a.details=e),await this.outcomeAdd(a)}async referralDeclined(t,e=null){const a={superOutcome:"Referral",outcome:"Declined - "+t,result:"fail"};e&&(a.details=e),await this.outcomeAdd(a)}async productAddedToCart(t,e=null){const a={superOutcome:"Add Product To Cart",outcome:"Add - "+t,result:"success"};e?a.price=e:e=0,await this.outcomeAdd(a),await this.heartbeatState(1),await this.count("Add To Cart",e)}async productNotAddedToCart(t){const e={superOutcome:"Add Product To Cart",outcome:"Ignore - "+t,result:"fail"};await this.outcomeAdd(e)}async upsold(t,e=null){const a={superOutcome:"Upsold Product",outcome:"Upsold - "+t,result:"success"};e?a.price=e:e=0,await this.outcomeAdd(a),await this.count("Upsell",e)}async upsellDismissed(t,e=null){const a={superOutcome:"Upsold Product",outcome:"Dismissed - "+t,result:"fail"};e&&(a.price=e),await this.outcomeAdd(a)}async checkOut(t=null){let e="Check Out",a="Check Out";null!=t&&(e="Check Out - "+t,a="Checkout:"+t);const r={superOutcome:"Customer Checkout",outcome:e,result:"success"};await this.outcomeAdd(r),await this.heartbeatState(2),await this.count(a)}async checkoutCanceled(){await this.outcomeAdd({superOutcome:"Customer Checkout",outcome:"Canceled",result:"fail"})}async productRemoved(t){const e={superOutcome:"Customer Checkout",outcome:"Product Removed - "+t,result:"fail"};await this.outcomeAdd(e)}async purchase(t,e=null,a=null,r=null,i=null){let n="Purchase",s="Purchase";null!=i&&(n="Purchase - "+i,s="Purchase:"+i);const o={superOutcome:"Customer Purchase",outcome:n,skus:t,result:"success"};e?o.price=e:e=0,a&&(o.discount=a),r&&(o.shipping=r),await this.outcomeAdd(o),await this.heartbeatState(3),await this.count(s,e)}async purchaseCancel(t=null,e=null){const a={superOutcome:"Customer Purchase",outcome:"Canceled"+(t?" - "+t:""),result:"fail"};e&&(a.price=e),await this.outcomeAdd(a)}async promiseFulfilled(){await this.outcomeAdd({superOutcome:"Promise Fulfillment",outcome:"Fulfilled",result:"success"})}async promiseUnfulfilled(){await this.outcomeAdd({superOutcome:"Promise Fulfillment",outcome:"Unfulfilled",result:"fail"})}async productKept(t){const e={superOutcome:"Product Disposition",outcome:"Kept - "+t,result:"success"};await this.outcomeAdd(e)}async productReturned(t){const e={superOutcome:"Product Disposition",outcome:"Returned - "+t,result:"fail"};await this.outcomeAdd(e)}async featureAttempted(t,e=null){const a={category:"Feature",action:"Attempted",name:t};e&&(a.details=e),await this.journeyAdd(a)}async featureCompleted(t,e=null){const a={category:"Feature",action:"Completed",name:t};e&&(a.details=e),await this.journeyAdd(a)}async featureFailed(t,e=null){const a={category:"Feature",action:"Failed",name:t};e&&(a.details=e),await this.journeyAdd(a)}async contentViewed(t,e=null){const a={category:"Content",action:"Viewed",type:t};e&&(a.identifier=e),await this.journeyAdd(a)}async contentEdited(t,e=null,a=null){const r={category:"Content",action:"Edited",type:t};e&&(r.identifier=e),a&&(r.details=a),await this.journeyAdd(r)}async contentCreated(t,e=null){const a={category:"Content",action:"Created",type:t};e&&(a.identifier=e),await this.journeyAdd(a)}async contentDeleted(t,e=null){const a={category:"Content",action:"Deleted",type:t};e&&(a.identifier=e),await this.journeyAdd(a)}async contentArchived(t,e=null){const a={category:"Content",action:"Archived",type:t};e&&(a.identifier=e),await this.journeyAdd(a)}async contentRequested(t,e=null){const a={category:"Content",action:"Requested",type:t};e&&(a.identifier=e),await this.journeyAdd(a)}async contentSearched(t){const e={category:"Content",action:"Searched",type:t};await this.journeyAdd(e)}async pageLoadTime(t,e){const a={category:"Webpage Load Time",time:t.toString(),identifier:e};await this.journeyAdd(a)}async milestone(t,e,a,r){const i={category:t,action:e,name:a,details:r};await this.journeyAdd(i)}async count(t,e=0,a=!1){const r=await Y("view-attribution");if(!r)return Promise.resolve(!0);let i={data:{uid:await this.id(),token:this.apiKey,timestamp:(new Date).getTime()/1e3,outcome:t,content:r,value:e}},n=await Y("view-count-replay");n?n.push(i):n=[i],await X("view-count-replay",n);try{let t=null;for(;n.length>0;){const e=n.shift();t=await this.CountApi(this.countApiUrl).fetch(e),await X("view-count-replay",n)}return t}catch(t){return a?Promise.reject(t):Promise.resolve(!0)}}async heartbeatState(t=null){const e=await z("heartbeat_stage");return t&&t>e&&await M("heartbeat_stage",t),t||e||await M("heartbeat_stage",0),Number(await z("heartbeat_stage"))}async commit(t=!1){if(!await this.sampleDecision()||this.apiCallPending)return Promise.resolve(!0);this.apiCallPending=!0;let e={data:{id:await this.id(),journey:await this.journey(),token:this.apiKey,timestamp:(new Date).getTime()/1e3}};const a=await this.reset();try{const t=await this.JourneyApi(this.apiUrl).fetch(e);return this.apiCallPending=!1,Promise.resolve(t)}catch(e){return await this.restore(a),this.apiCallPending=!1,t?Promise.reject(e):Promise.resolve(!0)}}async heartbeatMessage(t){const e=await this.heartbeatState(),a={ecom:{0:{expires_in_seconds:600,if_abandoned:{superOutcome:"Add Product To Cart",outcome:"Abandoned",result:"fail"}},1:{expires_in_seconds:600,if_abandoned:{superOutcome:"Customer Checkout",outcome:"Abandoned",result:"fail"}},2:{expires_in_seconds:600,if_abandoned:{superOutcome:"Customer Purchase",outcome:"Abandoned",result:"fail"}},3:{remove:!0}}};return Object.keys(a).includes(t)?a[t][e]:await z("heartbeat_outcome")}async heartbeat(t=!1){const e=await Y("view-platform"),a=await Y("view-tags");let r={data:{id:await this.id(),journey:await this.journey(),token:this.apiKey,platform:e||{},tags:a||[],timestamp:(new Date).getTime()/1e3}};const i=await z("heartbeat_type");if(i&&(r.data.watchdog=await this.heartbeatMessage(i)),!await this.sampleDecision()||this.apiCallPending)return Promise.resolve(!0);this.apiCallPending=!0;const n=await this.reset();try{const t=await this.HeartbeatApi(this.apiUrl).fetch(r);return i&&Object.keys(r.data.watchdog).includes("remove")&&(await $("heartbeat_stage"),await $("heartbeat_type"),await $("heartbeat_outcome")),this.apiCallPending=!1,Promise.resolve(t)}catch(e){return await this.restore(n),this.apiCallPending=!1,t?Promise.reject(e):Promise.resolve(!0)}}async deanonymize(t){if(!await this.sampleDecision())return Promise.resolve(!0);let e={data:{id:await this.id(),person:t,token:this.apiKey,timestamp:(new Date).getTime()/1e3}};return await this.DeanonApi(this.apiUrl).fetch(e)}async recordError(t){if(!await this.sampleDecision())return Promise.resolve(!0);let e={data:{log:t,token:this.apiKey}};return await this.ErrorLogApi(this.apiUrl).fetch(e)}async id(t){return t&&await X("xenon-view",t),(t=await Y("xenon-view"))&&""!==t?t:await this.newId()}async newId(){return await X("xenon-view",crypto.randomUUID()),await Y("xenon-view")}async sampleDecision(t=null,e=null){if(null!==t&&await X("xenon-will-sample",t),null===(t=await Y("xenon-will-sample"))||""===t){let a={data:{id:await this.id(),token:this.apiKey}};try{const r=await this.SampleApi(this.apiUrl).fetch(a);t=await this.sampleDecision(r.sample,e)}catch(a){if(a.authIssue&&e)return void e(a);t=await this.sampleDecision(!0,e)}}return t=Boolean(t)}async outcomeAdd(t){let e=await Y("view-platform");e&&(t.platform=e);let a=await Y("view-tags");a&&(t.tags=a),await this.journeyAdd(t)}async journeyAdd(t){let e=await this.journey();if(t.timestamp=(new Date).getTime()/1e3,this.pageURL_&&(t.url=this.pageURL_),e&&e.length){let a=e[e.length-1];if(this.isDuplicate(a,t)){let t=a.hasOwnProperty("count")?a.count:1;a.count=t+1}else e.push(t)}else e=[t];await this.storeJourney(e)}isDuplicate(t,e){const a=Object.keys(t),r=Object.keys(e);return!!((t,e)=>{for(const a of e)if(!t.has(a))return!1;return!0})(new Set(a),new Set(r))&&(!(!r.includes("category")||!a.includes("category"))&&(e.category===t.category&&(!(!r.includes("action")||!a.includes("action"))&&(e.action===t.action&&(this.duplicateFeature(t,e,a,r)||this.duplicateContent(t,e,a,r)||this.duplicateMilestone(t,e,a,r))))))}duplicateFeature(t,e,a,r){return"Feature"===e.category&&"Feature"===t.category&&e.name===t.name}duplicateContent(t,e,a,r){return"Content"===e.category&&"Content"===t.category&&(!r.includes("type")&&!a.includes("type")||e.type===t.type&&(!r.includes("identifier")&&!a.includes("identifier")||e.identifier===t.identifier&&(!r.includes("details")&&!a.includes("details")||e.details===t.details)))}duplicateMilestone(t,e,a,r){return"Feature"!==e.category&&"Feature"!==t.category&&("Content"!==e.category&&"Content"!==t.category&&(e.name===t.name&&e.details===t.details))}async journey(){return await z("view-journey")}async storeJourney(t){await M("view-journey",t)}async reset(){return this.restoreJourney=await this.journey(),await $("view-journey"),await this.storeJourney([]),this.restoreJourney}async restore(t=null){let e=await this.journey(),a=t||this.restoreJourney;null!==e&&e.length&&(a=a.concat(e)),a.sort((function(t,e){return t.timestamp<e.timestamp?-1:t.timestamp>e.timestamp?1:0})),await this.storeJourney(a),this.restoreJourney=[]}hasClassInHierarchy(t,e,a){const r=(t,e,a,i)=>!(i>=a)&&(!!t.className.toString().includes(e)||!!t.parentElement&&r(t.parentElement,e,a,i+1));return r(t,e,a,0)}decipherParamsPerLibrary(t){if(t.has("xenonSrc"))return[t.get("xenonSrc"),t.get("xenonId")];if(t.has("cr_campaignid"))return["Cerebro",t.get("cr_campaignid")];if(t.has("utm_source")&&"klaviyo"===t.get("utm_source").toLowerCase()){return["Klaviyo"+(t.has("utm_medium")?" - "+t.get("utm_medium"):""),t.get("utm_campaign")]}return t.has("g_campaignid")?["Google Ad",t.get("g_campaignid")]:t.has("utm_source")&&"shareasale"===t.get("utm_source").toLowerCase()||t.has("sscid")?["Share-a-sale",t.get("sscid")]:t.has("g_adtype")&&"none"===t.get("g_adtype")?["Google Organic",t.get("g_campaign")]:t.has("g_adtype")&&"search"===t.get("g_adtype")?["Google Paid Search",t.get("g_campaign")]:t.has("utm_source")&&"facebook"===t.get("utm_source")?["Facebook Ad",t.get("utm_campaign")]:t.has("utm_source")&&"email-broadcast"===t.get("utm_source").toLowerCase()?["Email",t.get("utm_campaign")]:t.has("utm_source")&&"youtube"===t.get("utm_source").toLowerCase()?["YouTube",t.get("utm_campaign")]:t.has("utm_source")?[t.get("utm_source"),t.get("utm_campaign")]:["Unattributed"]}async autodiscoverLeadFrom(t){if(t&&""!==t&&"?"!==t){const e=new URLSearchParams(t),[a,r]=this.decipherParamsPerLibrary(e);if(await Y("view-attribution"))return t;await X("view-attribution",{leadSource:a,leadCampaign:r,leadGuid:null});let i=await Y("view-tags");!a||i&&i.includes(a)||(i?(i.push(a),r&&i.push(r)):(i=[a],r&&i.push(r)),await this.variant(i),"Unattributed"===a?await this.leadUnattributed():await this.leadAttributed(a,r)),e.delete("xenonId"),e.delete("xenonSrc");let n="";return e.size&&(n="?"+e.toString()),n}{let e=await Y("view-tags");const a="Unattributed";return await Y("view-attribution")||(await X("view-attribution",{leadSource:a,leadCampaign:null,leadGuid:null}),e&&e.includes(a)||(e?e.push(a):e=[a],await this.variant(e),await this.leadUnattributed())),t}}pageURL(t){this.pageURL_=t}};return Z}();
